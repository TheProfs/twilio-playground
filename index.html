<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Twilio Playground</title>
    <style>
      * {
        font-family: sans-serif;
      }

      #connectedLabels,
      #roomControls {
        position: absolute;
        top: 4px;
        left: 4px;
        background: #fafafa;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgb(0 0 0 / 12%), 0 1px 2px rgb(0 0 0 / 24%);
        z-index: 99;
        padding: 8px 12px;
      }

      #roomControls > div {
        padding: 12px 0;
      }

      #connectedLabels {
        display: none;
      }

      button {
        cursor: pointer;
      }

      video {
        width: 250px;
      }
    </style>
    <script src="//sdk.twilio.com/js/video/releases/2.17.1/twilio-video.min.js"></script>
  </head>
  <body>
    <div id="connectedLabels">
      <h4> Connected </h4>
      <h5 id="roomNameLabel"></h5>
      <h5 id="roomTypeLabel"></h5>
      <h5 id="roomShouldRecordLabel"></h5>
    </div>

    <div id="roomControls">
      <div>
        <label for="roomNameInput">Room name:</label>
        <input
          id="roomNameInput"
          value="Test"
          type="text"
          name="name"
          minlength="4"
          maxlength="20"
          size="10"
          required>
      </div>

      <div>
        <label for="roomTypeSelect">Room type:</label>
        <select id="roomTypeSelect" name="room-types">
          <option value="go">Go</option>
          <option value="peer-to-peer">Peer To Peer</option>
          <option value="group-small">Group Small</option>
          <option value="group">Group</option>
        </select>
      </div>

      <div>
        <input id="recordCheckbox" type="checkbox" name="recordCheckbox">
        <label for="recordCheckbox">Record</label>
      </div>

      <div>
        <button id="connectBtn" type="button">Connect</button>
      </div>
    </div>

    <div id="local-media-div"></div>
    <div id="remote-media-div"></div>
  </body>


  <script>
    'use strict'

    const handleConnectAttempt = () => {
      document.querySelector('#connectBtn').innerText = 'Connecting...'
    }

    const handleConnectSuccess = ({ roomName, roomType, roomShouldRecord }) => {
      document.querySelector('#roomControls').style.display = 'none'
      document.querySelector('#connectedLabels').style.display = 'block'
      document.querySelector('#roomNameLabel').innerText = `Room: ${roomName}`
      document.querySelector('#roomTypeLabel').innerText = `Type: ${roomType}`
      document.querySelector('#roomShouldRecordLabel')
        .innerText = `Recording: ${roomShouldRecord ? 'yes' : 'false'}`
    }

    Twilio.Video.createLocalVideoTrack().then(track => {
      const localMediaContainer = document.getElementById('local-media-div')
      localMediaContainer.appendChild(track.attach())
    })

    document.querySelector('#connectBtn').addEventListener('click', async () => {
      console.log('Connecting...')

      const idUser = (Math.random() + 1).toString(36).substring(7)
      const roomName = document.querySelector('#roomNameInput').value
      const roomType = document.querySelector('#roomTypeSelect').value
      const roomShouldRecord = document.querySelector('#recordCheckbox').checked

      // Fetch token
      const token = await fetch('/token?' + new URLSearchParams({
        idUser,
        roomName
      }))
      .then(res => res.json())

      // Create room if not exists
      // `roomType` can be one of 'go', 'peer-to-peer', 'group-small', 'group'
      window.createdRoom = await fetch('/room', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ roomName, roomType, roomShouldRecord })
      })
      .then(res => res.json())

      const localTracks = await Twilio.Video.createLocalTracks({
        audio: true,
        video: { width: 640 }
      })

      handleConnectAttempt()

      const room = await Twilio.Video.connect(token, {
        name: createdRoom.uniqueName,
        tracks: []
      })

      handleConnectSuccess({ roomName, roomType, roomShouldRecord })
    })
  </script>
</html>
